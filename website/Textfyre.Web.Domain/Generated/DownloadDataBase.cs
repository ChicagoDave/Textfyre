/*
 *  DO NOT EDIT THIS CLASS.
 * 
 *  This class is generated by a tool and should not be edited. If you need to change the functionality of 
 *  this class, you should discuss your changes with the team and they should be implemented in the
 *  appropriate template.
 *  
 */
using System;
using System.Reflection;
using System.Data;
using System.Text;
using System.Collections.Generic;
using System.Data.SqlClient;
using Textfyre.Common.DataLayer;
using Textfyre.Common.Logging;
using Textfyre.TextfyreWeb.BusinessLayer;

namespace Textfyre.TextfyreWeb.DataLayer {

    /// <summary>
    /// Data Factory class that handles all database interaction for the Download table.
    /// </summary>
    [Serializable()]
    public abstract class DownloadDataBase {

        #region Members
        /// <summary>
        /// Main database controller for this table.
        /// </summary>
        [NonSerialized]
        private DBController _mainDBController;

        /// <summary>
        /// Main error and logging controller for this table.
        /// </summary>
        [NonSerialized]
        private DBController _errorDBController;

        /// <summary>
        /// Instance of the parameter factory class for the Download table.
        /// </summary>
        private Textfyre.TextfyreWeb.DataLayer.DownloadParameterFactory _parameterFactory;

        /// <summary>
        /// Instance of the cache manager.
        /// </summary>
        private ICacheManager _cacheManager;

        /// <summary>
        /// Expiration time period for a caching call.
        /// </summary>
        private string _cacheExpiration;

        /// <summary>
        /// String constant containing 'Download'.
        /// </summary>
        private const string TABLE_NAME = "Download";

        #endregion        

        /// <summary> 
        /// Empty default constructor. 
        /// </summary> 
        public DownloadDataBase() {
            GetDBControllers();
            GetCacheManager();
            _parameterFactory = new DownloadParameterFactory();
        }

        /// <summary>
        /// Protected property for the parameter factory.
        /// </summary>
        protected Textfyre.TextfyreWeb.DataLayer.DownloadParameterFactory ParameterFactory {
            get { return _parameterFactory; }
        }

        /// <summary>
        /// Protected property for the MainDBController.
        /// </summary>
        protected DBController MainDBController {
            get { return _mainDBController; }
        }

        /// <summary>
        /// Protected property for the ErrorDBController.
        /// </summary>
        protected DBController ErrorDBController {
            get { return _errorDBController; }
        }

        /// <summary>
        /// Public property for the cache manager.
        /// </summary>
        public ICacheManager CacheManager {
            get { return _cacheManager; }
        }

        /// <summary>
        /// Retrieves controllers using attribute search.
        /// </summary>
        private void GetDBControllers() {
            Type type = this.GetType();

            //Querying Class Attributes
            foreach (Attribute attr in type.GetCustomAttributes(true)) {
                if (attr.GetType() == typeof(DataSourceAttribute)) {
                    DataSourceAttribute dataSourceAttribute = attr as DataSourceAttribute;
                    _mainDBController = dataSourceAttribute.MainDBController;
                    _errorDBController = dataSourceAttribute.ErrorDBController;
                    break;
                }
            }
        }

        /// <summary>
        /// Private method that returns an instance of the cache manager object.
        /// </summary>
        private void GetCacheManager() {
            Type type = this.GetType();

            //Querying Class Attributes
            foreach (Attribute attr in type.GetCustomAttributes(true)) {
                if (attr.GetType() == typeof(CacheAttribute)) {
                    CacheAttribute cacheAttribute = attr as CacheAttribute;
                    _cacheManager = cacheAttribute.CacheManager;
                    _cacheExpiration = cacheAttribute.Expiration;
                    break;
                }
            }

            // If it doesn't find a cache attribute, then caching is not enabled for this domain object.
        }

        /// <summary>
        /// Private method that returns a SqlCommand from a list of arguments.
        /// </summary>
        private SqlCommand CreateCommand(string CommandText, List<SqlParameter> Parameters, bool isStoredProcedure) {
            SqlCommand sqlCmd = _mainDBController.CurrentConnection.CreateCommand();
            sqlCmd.CommandText = CommandText;

            if (isStoredProcedure)
                sqlCmd.CommandType = CommandType.StoredProcedure;
            else
                sqlCmd.CommandType = CommandType.Text;

            if((Parameters != null) && (Parameters.Count > 0))
                sqlCmd.Parameters.AddRange(Parameters.ToArray());

            //If there is an existing transaction, join it
            if(_mainDBController.HasTransaction)
                sqlCmd.Transaction = _mainDBController.CurrentTransaction;           

            return sqlCmd;
        }

        #region Standard DB Interface
        /// <sumamry>
        /// Get all records in the table.
        /// </summary>
        public virtual List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> GetAllDownload() {
            return ExecuteSqlGetCollection("SELECT [DownloadId], [ProductId], [PlatformId], [Version], [AvailableDate], [IsLocked], [IntelMac], [PowerPCMac], [WindowsXP], [WindowsVista], [Windows7], [Linux], [Unix], [WindowsMobile], [iPhone], [ScreenReader], [RequiresSilverlight], [RequiresFlash], [RequiresDotNet], [DotNetVersion], [RequiresMono], [RequiresMoonlight] FROM Download", null);
        }

        /// <summary>
        /// Get a single record in the table.
        /// </summary>
        public virtual Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset GetDownloadById(Int32 DownloadId) {
            if (DownloadId < 1)
                return null;

            string sql = "SELECT [DownloadId], [ProductId], [PlatformId], [Version], [AvailableDate], [IsLocked], [IntelMac], [PowerPCMac], [WindowsXP], [WindowsVista], [Windows7], [Linux], [Unix], [WindowsMobile], [iPhone], [ScreenReader], [RequiresSilverlight], [RequiresFlash], [RequiresDotNet], [DotNetVersion], [RequiresMono], [RequiresMoonlight] FROM Download WHERE [DownloadId] = @DownloadId";
            List<SqlParameter> parameters = new List<SqlParameter>();
            
			parameters.Add(ParameterFactory.GetParameter(DownloadFields.DownloadId, DownloadId));            

            return ExecuteSqlGetRecord(sql, parameters);
        }

        /// <summary>
        /// Insert a record into the table.
        /// </summary>
        public virtual Int32 InsertDownload(Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset record) {
            string sql = "INSERT INTO Download([ProductId], [PlatformId], [Version], [AvailableDate], [IsLocked], [IntelMac], [PowerPCMac], [WindowsXP], [WindowsVista], [Windows7], [Linux], [Unix], [WindowsMobile], [iPhone], [ScreenReader], [RequiresSilverlight], [RequiresFlash], [RequiresDotNet], [DotNetVersion], [RequiresMono], [RequiresMoonlight]) VALUES (@ProductId, @PlatformId, @Version, @AvailableDate, @IsLocked, @IntelMac, @PowerPCMac, @WindowsXP, @WindowsVista, @Windows7, @Linux, @Unix, @WindowsMobile, @iPhone, @ScreenReader, @RequiresSilverlight, @RequiresFlash, @RequiresDotNet, @DotNetVersion, @RequiresMono, @RequiresMoonlight); SELECT SCOPE_IDENTITY() as ID;";
            List<SqlParameter> parameters = new List<SqlParameter>();

			if(record.ProductId.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ProductId, record.ProductId.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ProductId, DBNull.Value));

			if(record.PlatformId.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PlatformId, record.PlatformId.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PlatformId, DBNull.Value));

			if(record.Version != null)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Version, record.Version));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Version, DBNull.Value));

			if(record.AvailableDate.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.AvailableDate, record.AvailableDate.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.AvailableDate, DBNull.Value));

			if(record.IsLocked.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IsLocked, record.IsLocked.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IsLocked, DBNull.Value));

			if(record.IntelMac.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IntelMac, record.IntelMac.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IntelMac, DBNull.Value));

			if(record.PowerPCMac.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PowerPCMac, record.PowerPCMac.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PowerPCMac, DBNull.Value));

			if(record.WindowsXP.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsXP, record.WindowsXP.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsXP, DBNull.Value));

			if(record.WindowsVista.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsVista, record.WindowsVista.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsVista, DBNull.Value));

			if(record.Windows7.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Windows7, record.Windows7.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Windows7, DBNull.Value));

			if(record.Linux.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Linux, record.Linux.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Linux, DBNull.Value));

			if(record.Unix.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Unix, record.Unix.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Unix, DBNull.Value));

			if(record.WindowsMobile.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsMobile, record.WindowsMobile.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsMobile, DBNull.Value));

			if(record.iPhone.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.iPhone, record.iPhone.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.iPhone, DBNull.Value));

			if(record.ScreenReader.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ScreenReader, record.ScreenReader.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ScreenReader, DBNull.Value));

			if(record.RequiresSilverlight.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresSilverlight, record.RequiresSilverlight.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresSilverlight, DBNull.Value));

			if(record.RequiresFlash.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresFlash, record.RequiresFlash.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresFlash, DBNull.Value));

			if(record.RequiresDotNet.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresDotNet, record.RequiresDotNet.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresDotNet, DBNull.Value));

			if(record.DotNetVersion != null)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.DotNetVersion, record.DotNetVersion));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.DotNetVersion, DBNull.Value));

			if(record.RequiresMono.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMono, record.RequiresMono.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMono, DBNull.Value));

			if(record.RequiresMoonlight.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMoonlight, record.RequiresMoonlight.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMoonlight, DBNull.Value));

            
			return Convert.ToInt32(ExecuteSqlGetScalar(sql, parameters));
        }

        /// <summary>
        /// Update a record in the table.
        /// </summary>
        public virtual int UpdateDownload(Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset record) {
            string sql = "UPDATE Download SET [ProductId] = @ProductId, [PlatformId] = @PlatformId, [Version] = @Version, [AvailableDate] = @AvailableDate, [IsLocked] = @IsLocked, [IntelMac] = @IntelMac, [PowerPCMac] = @PowerPCMac, [WindowsXP] = @WindowsXP, [WindowsVista] = @WindowsVista, [Windows7] = @Windows7, [Linux] = @Linux, [Unix] = @Unix, [WindowsMobile] = @WindowsMobile, [iPhone] = @iPhone, [ScreenReader] = @ScreenReader, [RequiresSilverlight] = @RequiresSilverlight, [RequiresFlash] = @RequiresFlash, [RequiresDotNet] = @RequiresDotNet, [DotNetVersion] = @DotNetVersion, [RequiresMono] = @RequiresMono, [RequiresMoonlight] = @RequiresMoonlight WHERE [DownloadId] = @DownloadId";
            List<SqlParameter> parameters = new List<SqlParameter>();

			parameters.Add(ParameterFactory.GetParameter(DownloadFields.DownloadId, record.DownloadId));
			if(record.ProductId.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ProductId, record.ProductId.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ProductId, DBNull.Value));

			if(record.PlatformId.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PlatformId, record.PlatformId.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PlatformId, DBNull.Value));

			if(record.Version != null)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Version, record.Version));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Version, DBNull.Value));

			if(record.AvailableDate.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.AvailableDate, record.AvailableDate.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.AvailableDate, DBNull.Value));

			if(record.IsLocked.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IsLocked, record.IsLocked.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IsLocked, DBNull.Value));

			if(record.IntelMac.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IntelMac, record.IntelMac.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.IntelMac, DBNull.Value));

			if(record.PowerPCMac.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PowerPCMac, record.PowerPCMac.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.PowerPCMac, DBNull.Value));

			if(record.WindowsXP.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsXP, record.WindowsXP.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsXP, DBNull.Value));

			if(record.WindowsVista.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsVista, record.WindowsVista.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsVista, DBNull.Value));

			if(record.Windows7.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Windows7, record.Windows7.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Windows7, DBNull.Value));

			if(record.Linux.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Linux, record.Linux.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Linux, DBNull.Value));

			if(record.Unix.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Unix, record.Unix.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.Unix, DBNull.Value));

			if(record.WindowsMobile.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsMobile, record.WindowsMobile.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.WindowsMobile, DBNull.Value));

			if(record.iPhone.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.iPhone, record.iPhone.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.iPhone, DBNull.Value));

			if(record.ScreenReader.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ScreenReader, record.ScreenReader.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.ScreenReader, DBNull.Value));

			if(record.RequiresSilverlight.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresSilverlight, record.RequiresSilverlight.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresSilverlight, DBNull.Value));

			if(record.RequiresFlash.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresFlash, record.RequiresFlash.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresFlash, DBNull.Value));

			if(record.RequiresDotNet.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresDotNet, record.RequiresDotNet.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresDotNet, DBNull.Value));

			if(record.DotNetVersion != null)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.DotNetVersion, record.DotNetVersion));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.DotNetVersion, DBNull.Value));

			if(record.RequiresMono.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMono, record.RequiresMono.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMono, DBNull.Value));

			if(record.RequiresMoonlight.HasValue)
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMoonlight, record.RequiresMoonlight.Value));
			else
				parameters.Add(ParameterFactory.GetParameter(DownloadFields.RequiresMoonlight, DBNull.Value));

            
            return ExecuteSqlGetNonScalar(sql, parameters);
        }

        /// <summary>
        /// Delete a record in the table.
        /// </summary>
        public virtual int DeleteDownload(Int32 DownloadId) {
            string sql = "DELETE FROM Download WHERE [DownloadId] = @DownloadId";
            List<SqlParameter> parameters = new List<SqlParameter>();

			parameters.Add(ParameterFactory.GetParameter(DownloadFields.DownloadId, DownloadId));

            
            return ExecuteSqlGetNonScalar(sql, parameters);
        }
        #endregion

        #region GetDataTable
        /// <summary>
        /// Execute a query stored by name in the web.config file and return a DataTable.
        /// </summary>
        public DataTable ExecuteQueryNameGetDataTable(string QueryName, List<SqlParameter> Parameters) {
            return ExecuteGetDataTable(_mainDBController.SqlText(QueryName), Parameters, false);
        }

        /// <summary>
        /// Execute a direct SQL statement and return a DataTable.
        /// </summary>
        public DataTable ExecuteSqlGetDataTable(string SqlText, List<SqlParameter> Parameters) {
            return ExecuteGetDataTable(SqlText, Parameters, false);
        }

        /// <summary>
        /// Execute a stored procedure and return a DataTable.
        /// </summary>
        public DataTable ExecuteSPGetDataTable(string SqlText, List<SqlParameter> Parameters) {
            return ExecuteGetDataTable(SqlText, Parameters, true);
        }

        /// <summary>
        /// Private method that handles public query execution.
        /// </summary>
        private DataTable ExecuteGetDataTable(string CmdText, List<SqlParameter> Parameters, bool isStoredProc) {
            SqlDataReader selectReader = null;
            DataTable selectTable = new DataTable();

            try {
                if(!_mainDBController.HasTransaction)
                    _mainDBController.CurrentConnection.Open();

                SqlCommand sqlCmd = CreateCommand(CmdText, Parameters, false);
                if (isStoredProc)
                    sqlCmd.CommandType = CommandType.StoredProcedure;
                else
                    sqlCmd.CommandType = CommandType.Text;
                selectReader = sqlCmd.ExecuteReader();

                // 
                // Use custom adapter to convert the reader to a datatable. 
                //
                SqlDataReaderAdapter Adapter = new SqlDataReaderAdapter();
                Adapter.Fill(selectTable, selectReader);

                sqlCmd.Parameters.Clear();
            } catch (SqlException sqlEx) {
                LogSqlException("ExecuteGetDataTable", sqlEx);                
                throw;
            } catch (Exception ex) {
                LogGenericException("ExecuteGetDataTable", ex);
                throw;
            } finally {
                if((selectReader != null) && (!selectReader.IsClosed))
                    selectReader.Close();

                if(!_mainDBController.HasTransaction) {
                    if(_mainDBController.CurrentConnection.State != ConnectionState.Closed)
                        _mainDBController.CurrentConnection.Close();
                }
            }

            return selectTable;
        }
        #endregion

        #region GetScalar
        /// <summary>
        /// Execute a query stored by name in the web.config file and return a scalar value.
        /// </summary>
        public object ExecuteQueryNameGetScalar(string QueryName, List<SqlParameter> Parameters) {
            return ExecuteScalar(_mainDBController.SqlText(QueryName), Parameters);
        }

        /// <summary>
        /// Execute a direct SQL Staement and return a scalar value.
        /// </summary>
        public object ExecuteSqlGetScalar(string SqlText, List<SqlParameter> Parameters) {
            return ExecuteScalar(SqlText, Parameters);
        }

        /// <summary>
        /// Private method that executes the scalar SQL call.
        /// </summary>
        private object ExecuteScalar(string CmdText, List<SqlParameter> Parameters) {             
            object o = null;

            try {
                if(!_mainDBController.HasTransaction)
                    _mainDBController.CurrentConnection.Open();

                SqlCommand sqlCmd = CreateCommand(CmdText, Parameters, false);
                o = sqlCmd.ExecuteScalar();
                sqlCmd.Parameters.Clear();
            } catch (SqlException sqlEx) {
                LogSqlException("ExecuteScalar", sqlEx);                
                throw;
            } catch (Exception ex) {
                LogGenericException("ExecuteScalar", ex);
                throw;
            } finally {
                if(!_mainDBController.HasTransaction) {
                    if(_mainDBController.CurrentConnection.State != ConnectionState.Closed)
                        _mainDBController.CurrentConnection.Close();
                }
            }
  
            return o;
        }
        #endregion

        #region GetNonScalar
        /// <summary>
        /// Execute a query stored by name in the web.config file. Returns the number of rows that
        /// were affected.
        /// </summary>
        public int ExecuteQueryNameGetNonScalar(string QueryName, List<SqlParameter> Parameters) {
            return ExecuteNonQuery(_mainDBController.SqlText(QueryName), Parameters);
        }

        /// <summary>
        /// Execute a direct SQL statement and return the number of rows affected.
        /// </summary>
        public int ExecuteSqlGetNonScalar(string SqlText, List<SqlParameter> Parameters) {
            return ExecuteNonQuery(SqlText, Parameters);
        }

        /// <summary>
        /// Private method that execute the nonquery.
        /// </summary>
        private int ExecuteNonQuery(string CmdText, List<SqlParameter> Parameters) {
            int rowsAffected = 0;

            try {
                if(!_mainDBController.HasTransaction)
                    _mainDBController.CurrentConnection.Open();

                SqlCommand sqlCmd = CreateCommand(CmdText, Parameters, false);
                rowsAffected = sqlCmd.ExecuteNonQuery();
                sqlCmd.Parameters.Clear();
            } catch (SqlException sqlEx) {
                LogSqlException("ExecuteNonQuery", sqlEx);                
                throw;
            } catch (Exception ex) {
                LogGenericException("ExecuteNonQuery", ex);
                throw;
            } finally {                
                if(!_mainDBController.HasTransaction) {
                    if(_mainDBController.CurrentConnection.State != ConnectionState.Closed)
                        _mainDBController.CurrentConnection.Close();
                }
            }

            return rowsAffected;
        }
        #endregion

        #region GetRecord
        /// <summary>
        /// Execute a query stored by name in the web.config file and return a strongly typed recordset.
        /// </summary>
        public Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset ExecuteQueryNameGetRecord(string QueryName, List<SqlParameter> Parameters) {
            return ExecuteGetRecord(_mainDBController.SqlText(QueryName), Parameters);
        }

        /// <summary>
        /// Execute a direct SQL statement and return a strongly typed recordset.
        /// </summary>
        public Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset ExecuteSqlGetRecord(string SqlText, List<SqlParameter> Parameters) {
            return ExecuteGetRecord(SqlText, Parameters);
        }        

        /// <summary>
        /// Private method that executes a sql command and returns a strongly typed recordset.
        /// </summary>
        private Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset ExecuteGetRecord(string CmdText, List<SqlParameter> Parameters) {
            List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> newDownloadRecordsetList = ExecuteReader(CmdText, Parameters, false);
            if(newDownloadRecordsetList.Count == 0)
                return null;

            return newDownloadRecordsetList[0];
        }        
        #endregion

        #region GetCollection
        /// <summary>
        /// Execute a query stored by name in the web.config file and return
        /// a strongly typed collection of recordsets.
        /// </summary>
        public List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> ExecuteQueryNameGetCollection(string QueryName, List<SqlParameter> Parameters) {
            return ExecuteReader(_mainDBController.SqlText(QueryName), Parameters, false);
        }

        /// <summary>
        /// Execute a direct SQL statement and return
        /// a strongly typed collection of recordsets.
        /// </summary>
        public List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> ExecuteSqlGetCollection(string SqlText, List<SqlParameter> Parameters) {
            return ExecuteReader(SqlText, Parameters, false);
        }

        /// <summary>
        /// Execute a stored procedure and return
        /// a strongly typed collection of recordsets.
        /// </summary>
        protected List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> ExecuteSPGetCollection(string StoredProcedureName, List<SqlParameter> Parameters) {
            return ExecuteReader(StoredProcedureName, Parameters, true);
        }

        #endregion

        #region Private functions

        /// <summary> 
        /// Load Items collection with data. 
        /// </summary> 
        /// <param name="drDownload"></param> 
        private List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> LoadItems(SqlDataReader drDownload) {           

            List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> newDownloadRecordsetList = new List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset>();
            bool namesMapped = false;
            Dictionary<string, int> fieldMap = null;

            // read through datareader, add items 
            while (drDownload.Read()) {

                if (!namesMapped) {
                    //Map field name to ordinal position
                    fieldMap = new Dictionary<string, int>();
                    for (int i = 0; i < drDownload.FieldCount; i++)
                        fieldMap.Add(drDownload.GetName(i), i);

                    namesMapped = true;
                }

                Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset newDownloadRecordset = new Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset();
                object o = null;

				if (fieldMap.ContainsKey("DownloadId")) {
					o = drDownload[fieldMap["DownloadId"]];
					if (o != DBNull.Value)
						newDownloadRecordset.DownloadId = (Int32)o;
				}

				if (fieldMap.ContainsKey("ProductId")) {
					o = drDownload[fieldMap["ProductId"]];
					if (o != DBNull.Value)
						newDownloadRecordset.ProductId = (Int32)o;
				}

				if (fieldMap.ContainsKey("PlatformId")) {
					o = drDownload[fieldMap["PlatformId"]];
					if (o != DBNull.Value)
						newDownloadRecordset.PlatformId = (Int32)o;
				}

				if (fieldMap.ContainsKey("Version")) {
					o = drDownload[fieldMap["Version"]];
					if (o != DBNull.Value)
						newDownloadRecordset.Version = ((string)o).Trim();
				}

				if (fieldMap.ContainsKey("AvailableDate")) {
					o = drDownload[fieldMap["AvailableDate"]];
					if (o != DBNull.Value)
						newDownloadRecordset.AvailableDate = (DateTime)o;
				}

				if (fieldMap.ContainsKey("IsLocked")) {
					o = drDownload[fieldMap["IsLocked"]];
					if (o != DBNull.Value)
						newDownloadRecordset.IsLocked = (bool)o;
				}

				if (fieldMap.ContainsKey("IntelMac")) {
					o = drDownload[fieldMap["IntelMac"]];
					if (o != DBNull.Value)
						newDownloadRecordset.IntelMac = (bool)o;
				}

				if (fieldMap.ContainsKey("PowerPCMac")) {
					o = drDownload[fieldMap["PowerPCMac"]];
					if (o != DBNull.Value)
						newDownloadRecordset.PowerPCMac = (bool)o;
				}

				if (fieldMap.ContainsKey("WindowsXP")) {
					o = drDownload[fieldMap["WindowsXP"]];
					if (o != DBNull.Value)
						newDownloadRecordset.WindowsXP = (bool)o;
				}

				if (fieldMap.ContainsKey("WindowsVista")) {
					o = drDownload[fieldMap["WindowsVista"]];
					if (o != DBNull.Value)
						newDownloadRecordset.WindowsVista = (bool)o;
				}

				if (fieldMap.ContainsKey("Windows7")) {
					o = drDownload[fieldMap["Windows7"]];
					if (o != DBNull.Value)
						newDownloadRecordset.Windows7 = (bool)o;
				}

				if (fieldMap.ContainsKey("Linux")) {
					o = drDownload[fieldMap["Linux"]];
					if (o != DBNull.Value)
						newDownloadRecordset.Linux = (bool)o;
				}

				if (fieldMap.ContainsKey("Unix")) {
					o = drDownload[fieldMap["Unix"]];
					if (o != DBNull.Value)
						newDownloadRecordset.Unix = (bool)o;
				}

				if (fieldMap.ContainsKey("WindowsMobile")) {
					o = drDownload[fieldMap["WindowsMobile"]];
					if (o != DBNull.Value)
						newDownloadRecordset.WindowsMobile = (bool)o;
				}

				if (fieldMap.ContainsKey("iPhone")) {
					o = drDownload[fieldMap["iPhone"]];
					if (o != DBNull.Value)
						newDownloadRecordset.iPhone = (bool)o;
				}

				if (fieldMap.ContainsKey("ScreenReader")) {
					o = drDownload[fieldMap["ScreenReader"]];
					if (o != DBNull.Value)
						newDownloadRecordset.ScreenReader = (bool)o;
				}

				if (fieldMap.ContainsKey("RequiresSilverlight")) {
					o = drDownload[fieldMap["RequiresSilverlight"]];
					if (o != DBNull.Value)
						newDownloadRecordset.RequiresSilverlight = (bool)o;
				}

				if (fieldMap.ContainsKey("RequiresFlash")) {
					o = drDownload[fieldMap["RequiresFlash"]];
					if (o != DBNull.Value)
						newDownloadRecordset.RequiresFlash = (bool)o;
				}

				if (fieldMap.ContainsKey("RequiresDotNet")) {
					o = drDownload[fieldMap["RequiresDotNet"]];
					if (o != DBNull.Value)
						newDownloadRecordset.RequiresDotNet = (bool)o;
				}

				if (fieldMap.ContainsKey("DotNetVersion")) {
					o = drDownload[fieldMap["DotNetVersion"]];
					if (o != DBNull.Value)
						newDownloadRecordset.DotNetVersion = ((string)o).Trim();
				}

				if (fieldMap.ContainsKey("RequiresMono")) {
					o = drDownload[fieldMap["RequiresMono"]];
					if (o != DBNull.Value)
						newDownloadRecordset.RequiresMono = (bool)o;
				}

				if (fieldMap.ContainsKey("RequiresMoonlight")) {
					o = drDownload[fieldMap["RequiresMoonlight"]];
					if (o != DBNull.Value)
						newDownloadRecordset.RequiresMoonlight = (bool)o;
				}


                newDownloadRecordset.IsDirty = false;
                newDownloadRecordsetList.Add(newDownloadRecordset);
            }
            
            return newDownloadRecordsetList;
        }

        /// <summary>
        /// Private method that returns a List<T> of DownloadRecordset
        /// </summary>
        private List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> ExecuteReader(string CmdText, List<SqlParameter> Parameters, bool isStoredProcedure) {
            SqlDataReader selectReader                                                           = null;
            List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> newDownloadRecordsetList = null;
            string cacheKey                                                                      = null;

            if (_cacheManager != null) {
                cacheKey = _cacheManager.CreateCacheKey(TABLE_NAME, Parameters);

                if (_cacheManager.Exists2(cacheKey)) {
                    newDownloadRecordsetList = _cacheManager.Get2< List<Textfyre.TextfyreWeb.BusinessLayer.DownloadRecordset> >(cacheKey);
                }
            }

            if (newDownloadRecordsetList == null) {
                try {
                    if (!_mainDBController.HasTransaction)
                        _mainDBController.CurrentConnection.Open();

                    SqlCommand sqlCmd = CreateCommand(CmdText, Parameters, isStoredProcedure);
                    selectReader = sqlCmd.ExecuteReader();

                    newDownloadRecordsetList = LoadItems(selectReader);
                    sqlCmd.Parameters.Clear();
                } catch (SqlException sqlEx) {
                    LogSqlException("ExecuteReader", sqlEx);
                    throw;
                } catch (Exception ex) {
                    LogGenericException("ExecuteReader", ex);
                    throw;
                } finally {
                    if ((selectReader != null) && (!selectReader.IsClosed))
                        selectReader.Close();

                    if (!_mainDBController.HasTransaction) {
                        if (_mainDBController.CurrentConnection.State != ConnectionState.Closed)
                            _mainDBController.CurrentConnection.Close();
                    }
                }

                if (_cacheManager != null) {
                    _cacheManager.Set2(cacheKey, newDownloadRecordsetList, _cacheExpiration);
                }
            }

            return newDownloadRecordsetList;
        }

        /// <summary>
        /// Private method to log and handle SQL Exceptions.
        /// </summary>
        private void LogSqlException(string methodName, SqlException sqlEx) {            
            if (sqlEx.Class >= 20) {
                Logger.LogMessage(typeof(DownloadDataBase).FullName, methodName, sqlEx,
                                  Severity.FATAL, LogLocation.ALL);
            } else if ((sqlEx.Class >= 11) && (sqlEx.Class < 20)) {
                Logger.LogMessage(typeof(DownloadDataBase).FullName, methodName, sqlEx,
                                  Severity.ERROR, LogLocation.ALL);
            } else if (sqlEx.Class < 11) {
                Logger.LogMessage(typeof(DownloadDataBase).FullName, methodName, sqlEx,
                                  Severity.INFO, LogLocation.ALL);
            }
        }

        /// <summary>
        /// Private method to log and handle general exceptions.
        /// </summary>
        private void LogGenericException(string methodName, Exception ex) {
            Logger.LogMessage(typeof(DownloadDataBase).FullName, methodName, ex,
                              Severity.ERROR, LogLocation.ALL);
        }

        #endregion
    }
}